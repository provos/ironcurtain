FROM ironcurtain-base:latest

# Install Claude Code CLI (Node.js is already in the base image)
USER root
RUN npm install -g @anthropic-ai/claude-code

# The entrypoint script copies runtime-generated config into the right
# location before the agent is invoked via docker exec.
COPY entrypoint-claude-code.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

USER codespace

# Pre-seed Claude Code config so it skips interactive prompts:
# - .claude.json: marks onboarding complete (skips login flow)
# - .claude/settings.json: accepts bypass-permissions mode (skips confirmation dialog)
RUN mkdir -p /home/codespace/.claude && \
    echo '{"hasCompletedOnboarding":true,"numStartups":1,"projects":{"/workspace":{"allowedTools":[],"hasTrustDialogAccepted":true}}}' \
      > /home/codespace/.claude.json && \
    echo '{"permissions":{"allow":[],"deny":[]},"skipDangerousModePermissionPrompt":true}' \
      > /home/codespace/.claude/settings.json

ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
